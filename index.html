<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>StartWallet Rescue</title>

    <link rel="apple-touch-icon" sizes="57x57" href="./favicon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="./favicon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="./favicon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="./favicon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="./favicon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="./favicon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="./favicon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="./favicon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./favicon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="./favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="./favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./favicon/favicon-16x16.png">
    <link rel="manifest" href="./favicon/manifest.json">

    <meta name="msapplication-TileColor" content="#404041">
    <meta name="msapplication-TileImage" content="./favicon/ms-icon-144x144.png">
    <meta name="theme-color" content="#404041">

    <link rel="stylesheet" href="./css/main.css">
    <link rel="stylesheet" href="./css/icons.css">
    <link rel="stylesheet" href="./css/foundation-icons.css">
    <link rel="stylesheet" href="./css/vendor.min.css">
    <link rel="stylesheet" href="./css/copay.min.css">
    <link rel="stylesheet" href="./css/switch.css">
    <link rel="stylesheet" href="./css/jquery-ui.min.css">

    <style>
      /* Copay */
      .title-text {
        font-size: 2em;
        font-style: italic;
        text-shadow: 1px 1px #000;
      }

      .settings {
        padding-top: 0 !important;
      }

      .home input[type="number"] {
        padding-left: 45px;
      }

      /* jQuery UI */
      .ui-widget-content {
        background: #F2F5F8;
        border: none;
      }

      .ui-widget-header {
        background: #01AEF0;
        border: 1px solid #8597A7;
        color: white;
        font-weight: bold;
      }
    </style>

    <script type="text/javascript" src="./js/jquery-1.12.2.min.js"></script>
    <script type="text/javascript" src="./js/jquery-ui.min.js"></script>
    <script type="text/javascript" src="./js/async.min.js"></script>
    <script type="text/javascript" src="./js/ajax.js"></script>
    <script type="text/javascript" src="./js/bitcore.js"></script>
    <script type="text/javascript" src="./js/sjcl.js"></script>

  </head>
  <body>

    <script type="text/javascript">

      var defaultSettings = {
        // StartCOIN Insight API instance to use
        explorerUrl: 'http://explorer.startcoin.org/',

        // Addresses to generate each round
        nAddresses: 30,

        // Only scan the blockchain or broadcast retrieve tx?
        scanOnly: false,

        // Set fee for miners
        fee: 0.1,

        // Number of required signers
        mReq: 1,

        // Logging output?
        verbose: true
      };

      var settings = {
        explorerUrl: defaultSettings.explorerUrl,
        nAddresses: defaultSettings.nAddresses,
        scanOnly: defaultSettings.scanOnly,
        fee: defaultSettings.fee,
        mReq: defaultSettings.mReq,
        verbose: defaultSettings.verbose
      };

      // Valid response from Insight API
      var explorerUrlTest = {
        txid: 'bb454a84bb6ccec9c53124afb800a84e99f56c247b0f7cc980d3b40102f64f8f',
        response: {  
          "txid":"bb454a84bb6ccec9c53124afb800a84e99f56c247b0f7cc980d3b40102f64f8f",
          "version":1,
          "locktime":0,
          "vin":[  
            {  
              "txid":"87aa70ee77cac55bdfd64bfec9110216f42a2c1444d09ef88fb2543efb11f3e6",
              "vout":0,
              "scriptSig":{  
                "asm":"3044022016cc50fbd6c37659ab572bf392b6c20e32b83791d6f6d4136ae670706feb8984022000d3ae5f94557efa24c384a0b43174c37f0d00425508e84aa12a6ff4979dc81c01 03ff200785c398eb598ecc9ed42c66f2ca1ad7d422606c3123eae5022a5750e39b"
              },
              "sequence":4294967295,
              "n":0,
              "addr":"sMGPpPXFvxpw9yQ4DkHfgqzVs6WsfonWD6",
              "valueSat":99990000,
              "value":0.9999,
              "doubleSpentTxID":null
            },
            {  
              "txid":"2ce6f2f392182be48aa9e5044b99e6b63c74e2c17a60f4e0e293564dbc6b866e",
              "vout":1,
              "scriptSig":{  
                "asm":"3046022100aa594d7da96e756bf68f041c5d41f16c4e9971b9ff52a6f9e6413c5c1afdfc84022100f9af62fbf2299824c74c073cf170a0be21dbe440d0cc0f1deefded29046dc4c701 02ddbbd4ead010af66cb35de6d37b874329e0914e6938a16007687b132b4d06bd1"
              },
              "sequence":4294967295,
              "n":1,
              "addr":"sRowqk4X7KjKvi1ugXkvUtAdm9EXgb55bc",
              "valueSat":79770000,
              "value":0.7977,
              "doubleSpentTxID":null
            }
          ],
          "vout":[  
            {  
              "value":"0.56310000",
              "n":0,
              "scriptPubKey":{  
                "asm":"OP_DUP OP_HASH160 2ed191cd247d538153beea6a7c8f82c22b80cec3 OP_EQUALVERIFY OP_CHECKSIG",
                "reqSigs":1,
                "type":"pubkeyhash",
                "addresses":[  
                  "sNWxDYa1hbnYs1ZvvfYP1wkDcC8rxaHvTJ"
                ]
              }
            },
            {  
              "value":"1.23450000",
              "n":1,
              "scriptPubKey":{  
                "asm":"OP_DUP OP_HASH160 0fc0718cc80f19a7dfe64d7b2b0472969d40d95d OP_EQUALVERIFY OP_CHECKSIG",
                "reqSigs":1,
                "type":"pubkeyhash",
                "addresses":[  
                  "sKggkfUsaUFWeHsfoRD1cZcE4yydfp21yg"
                ]
              }
            }
          ],
          "blockhash":"000000000085ce54665d063c6eee3314530bfb37c28581da996926be396c3231",
          "confirmations":25,
          "time":1459168903,
          "blocktime":1459168903,
          "valueOut":1.7976,
          "size":374,
          "valueIn":1.7976,
          "fees":0
        }
      };

      // Use the StartCOIN Bitcore bundle
      // This was taken from git://github.com/startcoin-project/bitcore.git#1a5c0c3d424a090f4709897a7e103545345529da and build using "npm install"
      var bitcore = require('bitcore');

      // bip32 paths, defined by Copay/StartWallet
      var bip32 = {
        basePath: 'm/45\'',
        copayPath: '/2147483647',
        receivePath: '/0',
        changePath: '/1'
      };

      // Array of addresses with a balance
      var addresses = {};

      var stats = {
        addresses: 0,
        balance: 0
      };

      var getTxDetails = function(explorerUrl, txid, success, err) {
        $.ajax({
          url: explorerUrl + 'api/tx/' + txid,
          type: 'GET',
          async: false
        }).done(success).error(err);
      };

      function isInt(n) {
        return n % 1 === 0;
      };

      function validateNAddresses() {
        hideMessages();
        var nAddresses = $('#naddresses').val();
        if (isNaN(nAddresses) || nAddresses <= 0 || !isInt(nAddresses)) {
          errorMessage('Addresses invalid', 'You must specify a positive number of addresses.');
          return false;
        }
        return true;
      };

      function validateFee() {
        hideMessages();
        var fee = $('#fee').val();
        if (isNaN(fee) || fee < 0.00000001) {
          errorMessage('Fee invalid', 'You must specify a positive fee.');
          return false;
        }
        if (fee < 0.0001) {
          warningMessage('Low fee', 'You have specified a low fee and your transaction may take a long time  to confirm.');
        }
        if (fee >= 1) {
          warningMessage('High fee', 'You have specified amount high fee. Please check the amount you have entered.');
        }
        return true;
      };

      function validateExplorerUrl(callback) {
        hideMessages();
        var explorerUrl = $('#explorerUrl').val();
        getTxDetails(explorerUrl, explorerUrlTest.txid,
          function(data) {
            if (data.valueIn === explorerUrlTest.response.valueIn &&
                data.valueOut === explorerUrlTest.response.valueOut &&
                data.blockhash === explorerUrlTest.response.blockhash) {
              callback(true);
            } else {
              errorMessage('Explorer invalid', 'The website returned unexpected data. Is it running the StartCOIN version of Insight API?');
              callback(false);
            }
        },
          function(err) {
            errorMessage('Explorer invalid', 'The explorer address is invalid.');
            callback(false);
        });
      };

      function validateSettings(callback) {
        if (!validateNAddresses()) return false;
        if (!validateFee()) return false;
        validateExplorerUrl(callback);
      };

      function updateSettingsObject() {
        settings.explorerUrl = $('#explorerUrl').val();
        settings.nAddresses = $('#naddresses').val();
        settings.scanOnly = $('#scanonly').prop('checked');
        settings.fee = $('#fee').val();
      };

      function saveSettings() {
        $('#btnSettingsSave').prop('disabled', true);
        validateSettings(function(valid){
          if (valid) {
            updateSettingsObject();
            showPhase1(); 
          }
          $('#btnSettingsSave').prop('disabled', false);
        });
      };

      function _resetSettings(s) {
        $('#explorerUrl').val(s.explorerUrl);
        $('#naddresses').val(s.nAddresses);
        $('#scanonly').prop('checked', s.scanOnly);
        $('#fee').val(s.fee);
      };

      function resetSettings() {
        return _resetSettings(settings);
      };

      function resetDefaultSettings() {
        return _resetSettings(defaultSettings);
      };

      function showSettings(){
        hideMessages();
        $('#phase1').addClass('none');
        $('#settings').removeClass('none');
      };

      function showBackup(){
        hideMessages();
        $('#phase1').addClass('none');
        $('#backup').removeClass('none');
      };

      function showHelp(){
        hideMessages();
        $('#phase1').addClass('none');
        $('#help').removeClass('none');
      };

      function showWalletPassword(){
        $('#backupBackup').prop('disabled', true);
        $('#backupPassword').prop('disabled', true);
        $('#backup-wallet-password').removeClass('none');
      };

      function showPhase1(){
        hideMessages();

        if (settings.scanOnly) {
          $('#address-input').addClass('none');
        } else {
          $('#address-input').removeClass('none');
        }

        $('#settings').addClass('none');
        $('#backup').addClass('none');
        $('#help').addClass('none');
        $('#phase2').addClass('none');
        $('#phase1').removeClass('none');

        setRescueButtonState();
      };

      function showPhase2(){
        hideMessages();
        $('#settings').addClass('none');
        $('#backup').addClass('none');
        $('#help').addClass('none');
        $('#phase1').addClass('none');

        $('#phase2').removeClass('none');
      };

      function showPhase3(hide){
        if (hide) hideMessages();
        $('#settings').addClass('none');
        $('#backup').addClass('none');
        $('#help').addClass('none');
        $('#phase1').addClass('none');
        $('#phase2').addClass('none');
        $('#phase3').removeClass('none');
      };

      function showTransactionInfo() {
        $('#phase3-transaction').removeClass('none');
        $('#phase3-txid-list').removeClass('none');
      };

      function showAddressInfo() {
        $('#phase3-results-dialog').dialog({
          modal: true,
          width: 'auto'
        });
      };

      function hideMessages() {
        $('#note-success').addClass('none');
        $('#note-warning').addClass('none');
        $('#note-error').addClass('none');
      };

      function successMessage(title, text) {
        $('#note-success-title').html(title);
        $('#note-success-text').html(text);
        $('#note-success').removeClass('none');
      };

      function warningMessage(title, text) {
        $('#note-warning-title').html(title);
        $('#note-warning-text').html(text);
        $('#note-warning').removeClass('none');
      };

      function errorMessage(title, text) {
        $('#note-error-title').html(title);
        $('#note-error-text').html(text);
        $('#note-error').removeClass('none');
      };

      function makeAddressesTable() {
        var resultsTable = $('#phase3-results');
        resultsTable.find("tr:gt(0)").remove();
        $.each(addresses, function(i, address) {
          var str = '<tr>';
          str += '<td><a href=\"'+settings.explorerUrl+'address/'+address.addr.toString()+'\" target=\"_blank\">'+address.addr.toString()+'</a></td>';
          str += '<td>'+address.details.balance+' START</td>';
          str += '</tr>';
          resultsTable.append(str);
        });
      };

      function addTxidToList(txid, amount) {
        var list = $('#phase3-txid-list');
        var str = '<li>';
        str += '<span class=\"text-gray\">';
        str += '<i class=\"fi-bitcoin-circle\"></i>'
        str += '</span> ';
        str += '<a href=\"'+settings.explorerUrl+'tx/'+txid+'\" title=\"Click here to view the transaction on the blockchain explorer\" target=\"_blank\">'+amount+' START</a>';
        str += '</li>';
        list.append(str);
      };

      function validMasterPrivateKey(xprv) {
        var xprv = xprv || $('#xprv').val();
        var hkey = null;
        try {
          hkey = new bitcore.HierarchicalKey(xprv);
        }
        catch (e) {
          return false;
        }
        if (hkey) {
          return true;
        }
        return false;
      };

      function validAddress(address) {
        var address = address || $('#address').val();
        return bitcore.Address.validate(address);
      };

      function validBackup(backup) {
        var backup = backup || $('#backupBackup').val();

        // TODO - what is a valid backup?

        if (typeof backup === 'string') {
          try {
            var obj = JSON.parse(backup);
          } catch (e) {
            if (settings.verbose) console.log('Failed to parse backup JSON');
            return false;
          }
        }

        return true;
      };

      function validPassword(password) {
        var password = password || $('#backupPassword').val();
        return (password.length > 0);
      }

      function setRescueButtonState() {
        var disabled = !(validMasterPrivateKey() && validAddress());

        if (settings.scanOnly)
          disabled = !validMasterPrivateKey();
        
        $('#btnRescue').prop('disabled', disabled);
      };

      function setDecryptButtonState() {
        var disabled = !(validBackup() && validPassword());
        $('#btnBackupDecrypt').prop('disabled', disabled);
      };

      function decryptWallet(backup, password) {
        var backup = backup || $('#backupBackup').val();
        var plain, obj;

        try {
          plain = sjcl.decrypt(password, backup.xPrivKeyEncrypted);

          if (plain) {
            $('#xprv').val(plain);
            showPhase1();
          } else {
            hideMessages();
            errorMessage('Unknown backup format', 'We are not able to decrypt this format. Please contact <a href="mailto:grace@startjoin.com">StartJOIN</a> for help.')
          }
        } catch (err) {
          console.error('Could not decrypt backup with wallet encryption', err);
          return false;
        }

        return true;
      };

      var walletBackup;

      function decrypt() {
        var plain, obj;
        try {
          var backup = $('#backupBackup').val();
          var password = $('#backupPassword').val();

          plain = sjcl.decrypt(password, backup);
          obj = JSON.parse(plain);

          if (obj.privateKey && obj.privateKey.extendedPrivateKeyString) {
            $('#xprv').val(obj.privateKey.extendedPrivateKeyString);
            showPhase1();
          }
          else if (obj.xPrivKey) {
            $('#xprv').val(obj.xPrivKey);
            showPhase1();
          }
          else if (obj.xPrivKeyEncrypted) {

            // Create a closure for the new handler
            var decryptWalletHandler = (function(backup){
              return function() {
                var password = $('#backupWalletPassword').val()
                decryptWallet(backup, password);
              }
            })(obj);

            // Override decrypt button listener
            $('#btnBackupDecrypt').click(decryptWalletHandler);

            // First check original password
            if (!decryptWallet(obj, password)) {
              hideMessages();
              warningMessage('Wallet encryption enabled', 'You have enabled wallet encryption. Please enter your wallet password.');
              showWalletPassword();
            }
          }
          else {
            hideMessages();
            errorMessage('Unknown backup format', 'We are not able to decrypt this format. Please contact <a href="mailto:grace@startjoin.com">StartJOIN</a> for help.')
          }
        } catch(err) {
          console.error(err);
          errorMessage('Cannot decrypt backup', 'Please check your password and try again.');
        }
      };

      // Retrieve UTXOs from Insight
      var getUtxos = function(addr, callback) {
        $.ajax({
          url: settings.explorerUrl + 'api/addr/' + addr.toString() + '/utxo?noCache=1',
          type: 'GET'
        }).done(function(data){
          callback(data);
        }).error(function(xhr){
          console.error(xhr);
          errorMessage('Cannot contact explorer', 'Unable to retrieve UTXOs for address ' + addr.toString());
        });
      };

      // Create XML HTTP Request
      function createRequest() {
        var result = null;
        if (window.XMLHttpRequest) {
          // FireFox, Safari, etc.
          result = new XMLHttpRequest();
          if (typeof result.overrideMimeType != 'undefined') {
            result.overrideMimeType('text/xml'); // Or anything else
          }
        }
        else if (window.ActiveXObject) {
          // MSIE
          result = new ActiveXObject("Microsoft.XMLHTTP");
        } 
        else {
          // No known mechanism -- consider aborting the application
          errorMessage('Fatal error', 'Unable to create HTTP request. Please use a newer browser.');
        }
        return result;
      };

      // Broascast sweep transaction to Insight
      var broadcastTx = function(signedtx, callback) {
        var req = createRequest();

        req.onreadystatechange = function() {
          // Sending...
          if (req.readyState != 4) {
            return;
          }

          // Error
          if (req.status != 200) {
            console.error(req);
            errorMessage('Cannot contact explorer', 'Unable to broadcast sweep transaction (Status: ' + req.status + ')');
            return;
          }

          // Success
          return callback(JSON.parse(req.responseText));
        };

        req.open('POST', settings.explorerUrl + 'api/tx/send', true);
        req.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
        req.send('rawtx=' + signedtx);
      };

      function getDetailsItem(addr, addressObj, callback) {
        fetch(settings.explorerUrl + 'api/addr/' + addr.toString() + '?noTxList=1&noCache=1', function(xhr) {
          var details = JSON.parse(xhr.responseText);
          addressObj.details = details;
          var found = false;

          if (details.balance > settings.fee) {
            found = true;

            // Add to stats object
            stats.addresses++;
            stats.balance += parseFloat(details.balance);

            if (settings.verbose) console.log(addr.toString() + ' has a balance of ' + details.balance + ' START');

            // Add to results
            addresses[addr.toString()] = addressObj;

            // Increment found text
            $('#phase2-addresses').text(stats.addresses);
            $('#phase2-balance').text(stats.balance + ' START');
          }

          callback(null, found);
        });
      };

      function scanItem(path, hkey, i, callback) {
        // Derive a P2PKH address
        var pub = hkey.derive(path + '/' + i).eckey.public;
        var prv = hkey.derive(path + '/' + i).eckey.private;

        // Make Bitcore private key object
        var prvKey = new bitcore.PrivateKey(bitcore.networks.livenet.privKeyVersion, prv, true);

        // Make an address
        var pubkeys = []
        var wk = new bitcore.WalletKey();
        wk.fromObj({
          priv: prvKey.toString()
        });
        pubkeys.push(wk.privKey.public);
        
        var addr = wk.storeObj().addr;

        if (settings.verbose) console.log(path + '/' + i + ' ' + addr.toString() + ':' + prvKey.toString());

        // Create a 1-of-m multisig address from that
        var pubKeys = pubkeys;
        var script = bitcore.Script.createMultisig(settings.mReq, pubKeys);

        mAddr = bitcore.Address.fromScript(script);

        if (settings.verbose) console.log('1-of-' + settings.mReq + ' multisig address: ' + mAddr.toString());

        var addressObj = {
          addr: mAddr,
          script: script,
          private: prvKey,
          public: pubKeys
        };

        // Check for a balance
        getDetailsItem(mAddr, addressObj, callback);
      };

      function scanPath(path, hkey, n, start, callback) {
        start = start || 0;

        var found = false;

        var tasks = [];
        for (var i = start; i < (start + n); i++) {
          // Create task function in closure
          var task = function(index){
            return function(next) {
              scanItem(path, hkey, index, function(err, _found) {
                if (_found) found = true;

                // Update progress bar
                var pb = $('#progressbar');
                var pbVal = pb.progressbar('value');
                pb.progressbar('value', pbVal + 1);

                next(err);
              });
            };
          }(i);

          // Push to task array
          tasks.push(task);
        }

        async.series(tasks, function(err) {
          callback(err, found);
        });
      };

      function scanRound(hkey, nAddresses, count, callback) {
        // Increment round text
        // Increment by one to prevent 0-indexing
        $('#phase2-round').text(count + 1);

        // New scan paths
        var tasks = [
          function(next) {
            scanPath(bip32.basePath + bip32.copayPath + bip32.changePath, hkey, nAddresses, nAddresses*count, function(err, found) {
              next(err, found);
            });
          },

          function(next) {
            scanPath(bip32.basePath + bip32.copayPath + bip32.receivePath, hkey, nAddresses, nAddresses*count, function(err, found) {
              next(err, found);
            });
          },
        ];

        // Old scan paths
        for (var i = 0; i < settings.mReq; i++) {
          var changeTask = function(index) {
            return function(next) {
              scanPath(bip32.basePath + ('/' + index) + bip32.changePath, hkey, nAddresses, nAddresses*count, function(err, found) {
                next(err, found);
              });
            };
          }(i);
          tasks.push(changeTask);

          var receiveTask = function(index) {
            return function(next) {
              scanPath(bip32.basePath + ('/' + index) + bip32.receivePath, hkey, nAddresses, nAddresses*count, function(err, found) {
                next(err, found);
              });
            };
          }(i);
          tasks.push(receiveTask);
        }

        // Set up the progress bar
        $('#progressbar').progressbar({
          value: 0,
          max: (settings.nAddresses * tasks.length)
        });

        // Reset progress bar
        $('#progressbar').progressbar('value', 0);

        async.series(tasks, function(err, found) {
          var params = {hkey: hkey, nAddresses: nAddresses, count: count};
          callback(err, found, params);
        });
      };

      function scanCallback(err, found, params) {
        if (err) {
          console.error(err);
          return errorMessage('Scanning failed', 'We were unable to scan for addresses.');
        }
        var filtered = found.filter(function(f){return f});
        if (filtered.length) return scanRound(params.hkey, params.nAddresses, params.count+1, scanCallback);
        else return finishScanning(params.count);
      };

      function scan() {
        var xprv = $('#xprv').val();
        var hkey = new bitcore.HierarchicalKey(xprv);

        // Display?
        if (settings.verbose) {
          console.log('Master extended private key: ' + hkey.extendedPrivateKeyString());
          console.log('Master extended public key: ' + hkey.extendedPublicKeyString());
          console.log();
        }

        // Get the number of addresses in each round
        var nAddresses = parseInt(settings.nAddresses);

        // Set up addresses text
        $('#phase2-naddresses').text(nAddresses);

        // Set up addresses found & balance text 
        $('#phase2-addresses').text(stats.addresses);
        $('#phase2-balance').text(stats.balance + ' START');

        // Scan for addresses, both receive and change.
        // Repeat in batches of nAddresses until nothing is found.
        scanRound(hkey, nAddresses, 0, scanCallback);
      };

      function finishScanning(count) {
        if (settings.verbose) console.log('Searched ' + count + ' rounds of ' + settings.nAddresses + ' addresses.');

        // Was anything found?
        if (stats.addresses > 0) {

          // Do we need to sweep the addresses?
          if (!settings.scanOnly) {
            var address = $('#address').val();
            if (address !== '') {
              if (bitcore.Address.validate(address)) {
                sweep();
              } else {
                errorMessage('Invalid address', 'The destination address is not a valid StartCOIN address.');
              }
            } else {
              warningMessage('Retrieval', 'You did not include a destination address. Please start again and provide one to retreive your coins.');
            }
          }
        } else {
          // Show error message
          errorMessage('No addresses found', 'We were unable to find any addresses with a balance.')
        }

        $('#phase3-addresses').text(stats.addresses);
        $('#phase3-balance').text(stats.balance + ' START');
        showPhase3(false);
      };

      // Sweep address balance to a specified address
      var sweep = function() {

        // Specified destination address
        var outAddr = $('#address').val();

        // Add to phase 3 UI
        $('#phase3-destination').text(outAddr);

        $.each(addresses, function(i, address) {
          getUtxos(address.addr, function(utxos) {

            utxos = utxos.map(function(utxo) {
              utxo.scriptPubKey = bitcore.Script.fromHumanReadable(utxo.scriptPubKey).toString('hex');
              return utxo;
            })

            // Make pubkeys object
            var pubkeys = []
            var wk = new bitcore.WalletKey();
            wk.fromObj({
              priv: address.private.toString()
            });
            pubkeys.push(bitcore.buffertools.toHex(wk.privKey.public));

            var opts = {
              nReq: settings.mReq,
              pubkeys: pubkeys,
              fee: settings.fee
            };

            var outs = [{
              address: outAddr,
              amount: (address.details.balance - settings.fee)
            }];

            // Map the redeem script to its p2sh address
            // https://github.com/bitpay/bitcore/issues/286
            var hashMap = {};
            hashMap[address.addr.toString()] = address.script.serialize();

            // Build the transaction
            var tx = (new bitcore.TransactionBuilder(opts))
              .setUnspent(utxos)
              .setHashToScriptMap(hashMap)
              .setOutputs(outs)
              .sign([address.private.toString()])
              .build();

            // Is the TX completely signed?
            var missingSigs = tx.countInputMissingSignatures(0);
            if (settings.verbose) console.log('Missing signatures: ', missingSigs);

            if (missingSigs == 0) {
              var txHex = tx.serialize().toString('hex');

              broadcastTx(txHex, function(res) {
                if (settings.verbose) {
                  console.log('Transaction: ', txHex);
                  console.log('=> TXID: ', res.txid);
                }

                addTxidToList(res.txid, (address.details.balance - settings.fee));
                showTransactionInfo();
              });
            }
          });
        });
      };

      $(function(){
        // Reset settings to default
        resetDefaultSettings();

        // Set up button handlers
        $('#btnSettingsSave').click(saveSettings);
        $('#btnSettingsBack').click(function() {
          resetSettings();
          showPhase1();
        });
        $('#btnSettingsReset').click(function() {
          resetDefaultSettings();
          showPhase1();
        });

        $('#btnHelpBack').click(showPhase1);

        $('#btnBackupBack').click(showPhase1);

        $('#btnBackupDecrypt').click(decrypt);

        $('#btnPhase1Help').click(showHelp);
        $('#btnPhase1Backup').click(showBackup);
        $('#btnPhase1Settings').click(showSettings);

        $('#btnRescue').click(function() {
          showPhase2();
          scan();
        });

        $('#btnPhase2Cancel').click(function() {
          document.location.reload(true);
        });

        $('#btnPhase3StartAgain').click(function() {
          document.location.reload(true);
        });

        $('#btnPhase3Addresses').click(function() {
          makeAddressesTable();
          showAddressInfo();
        });

        // Set up validation handlers
        $('#explorerUrl').change(function() {
          validateExplorerUrl(function(valid){
            // Do nothing
          });
        });
        $('#naddresses').change(validateNAddresses);
        $('#fee').change(validateFee);

        // Check for a valid backup and enable the decrypt button
        // when it's been found.
        $('#backupBackup').bind('input propertychange', function() {
          setDecryptButtonState();
        });

        // Check for a valid backup password and enable the decrypt button
        // when it's been found.
        $('#backupPassword').bind('input propertychange', function() {
          setDecryptButtonState();
        });

        // Check for a valid xprv and enable the rescue button
        // when it's been found.
        $('#xprv').bind('input propertychange', function() {
          setRescueButtonState();
        });

        // Check for a valid receive address.
        // Disable the rescue button if it's enabled and an incorrect
        // address has been entered.
        $('#address').bind('input propertychange', function() {
          setRescueButtonState();
        });
      });
    </script>

    <div class="page">
      <div class="off-canvas-wrap">
        <div class="inner-wrap">
          <div class="home">
            <section>
              <div class="large-5 large-centered medium-7 medium-centered columns">
                <div class="logo-setup">
                  <p class="title-text"><span class="text-white">StartWallet</span> <span class="text-gray">Rescue</span></p>
                </div>

                <!-- Notification boxes -->
                <div id="note-success" class="box-notification none">
                  <div class="box-icon">
                    <i class="fi-check size-24"></i>
                  </div>
                  <div class="text-success size-14">
                    <h3 id="note-success-title"></h3>
                    <span id="note-success-text"></span>
                  </div>
                </div>

                <div id="note-warning" class="box-notification none">
                  <div class="box-icon warning">
                    <i class="fi-info size-24"></i>
                  </div>
                  <span class="text-warning size-14">
                    <h3 id="note-warning-title"></h3>
                    <span id="note-warning-text"></span>
                  </span>
                </div>

                <div id="note-error" class="box-notification none">
                  <div class="box-icon error">
                    <i class="fi-x size-24"></i>
                  </div>
                  <span class="text-warning size-14">
                    <h3 id="note-error-title"></h3>
                    <span id="note-error-text"></span>
                  </span>
                </div>
                <!-- End of Notification boxes -->

                <!-- Settings page -->
                <div id="settings" class="settings none">
                  <form name="settingsForm">
                    <fieldset>
                      <legend>StartCOIN Explorer</legend>
                      <div class="row collapse">
                        <label class="left" for="explorerUrl">StartCOIN Explorer URL</label>
                        <div id="settings-explorer-error" class="has-error right size-12 none">
                          <span class="icon-input"><i class="fi-x"></i></span>
                          <span>Not valid</span>
                        </div>
                      </div>
                      <div class="input">
                        <input type="text" id="explorerUrl" name="explorerUrl" class="form-control" required="true" placeholder="Explorer URL">
                        <i class="fi-link"></i>
                      </div>

                      <small class="text-gray">
                        This is the service used by StartWallet Rescue to check address balances and to broadcast signed transactions. StartCOIN Explorer is open-source software. You can run your own instances (see 
                        <a href="https://github.com/startcoin-project/insight-api" target="_blank">GitHub</a>).
                      </small>
                    </fieldset>

                    <fieldset>
                      <legend>Scanning</legend>
                      <div class="row collapse">
                        <label class="left" for="naddresses">Addresses</label>
                        <div id="settings-naddresses-error" class="has-error right size-12 none">
                          <span class="icon-input"><i class="fi-x"></i></span>
                          <span>Not valid</span>
                        </div>
                      </div>
                      <div class="input">
                        <input type="number" step="1" id="naddresses" name="naddresses" class="form-control" required="true" placeholder="Addresses to Scan">
                        <i class="fi-magnifying-glass"></i>
                      </div>

                      <small class="text-gray">
                        The number of addresses to scan at each round. If no address with a balance is found in a round StartWallet Rescue finishes searching. A high value may find more addresses but will take longer to run.</small>
                    </fieldset>

                    <fieldset>
                      <legend>Retrieval</legend>

                      <div class="row collapse">
                        <label class="left" for="fee">Fee</label>
                        <div id="settings-fee-error" class="has-error right size-12 none">
                          <span class="icon-input"><i class="fi-x"></i></span>
                          <span>Not valid</span>
                        </div>
                      </div>
                      <div class="input">
                        <input type="number" step="0.0001" id="fee" name="fee" class="form-control" required="true" placeholder="Transaction Fee">
                        <i class="fi-bitcoin"></i>
                      </div>

                      <div class="row collapse">
                        <label class="left" for="scanonly">Scan only?</label>
                      </div>
                      <div>
                        <label class="switch-light switch-candy" onclick="">
                          <input type="checkbox" name="scanonly" id="scanonly">
                          <span>
                            <span>Off</span>
                            <span>On</span>
                            <a></a>
                          </span>
                        </label>
                      </div>

                      <small class="text-gray">
                        StartWallet Rescue can be set to scan for balances or to sign a transaction sweeping them to a specified destination address.</small>
                    </fieldset>

                    <button type="button" id="btnSettingsSave" class="button primary radius expand m0">Save</button>
                  </form>

                  <div class="box-setup-footer">
                    <div class="right">
                      <a id="btnSettingsReset" class="button outline dark-gray tiny">
                        <i class="fi-page-delete show-for-large-up size-14"></i> 
                        <span>Reset Settings</span>
                      </a>
                    </div>

                    <div class="left m10r">
                      <a id="btnSettingsBack" class="button outline dark-gray tiny ng-click-active">
                        <i class="fi-arrow-left show-for-large-up size-14"></i> 
                        <span>Back</span>
                      </a>
                    </div>
                  </div>
                </div>
                <!-- End of Settings page -->

                <!-- Help page -->
                <div id="help" class="none">
                  <div class="text-gray">
                    <p>This tool was created to help users retrieve funds stuck in at <a href="https://startwallet.com/" target="_blank" title="Click here to go to StartWallet">StartWallet.com</a>.</p>

                    <p>To retrieve your coins you will need your master private key. You can find this by logging into your account at StartWallet and navigating to <a href="https://startwallet.com/#!/moreSettings" target="_blank" title="Click here to go to your StartWallet settings">Settings</a>, clicking "Show advanced options" and then clicking the button that says "Show" beneath the heading "Master Private Key".</p>

                    <p>You will also need a StartCOIN address to send your coins to. You can generate an address by downloading the StartCOIN desktop client from <a href="https://www.startcoin.org/#wallet" target="_blank" title="Click here to go to the StartCOIN download page">here</a>. Once you have installed the wallet click the "Receive" tab to find your addresses.</p>

                    <p>To contact the StartCOIN team you can email <a href="mailto:grace@startjoin.com" target="_blank" title="Click to email Grace at StartCOIN">Grace</a> or tweet to <a href="https://twitter.com/start_coin" target="_blank" title="Click here to tweet to @start_coin">@start_coin</a>.</p>
                  </div>

                  <div class="box-setup-footer">
                    <div class="left m10r">
                      <a id="btnHelpBack" class="button outline dark-gray tiny ng-click-active">
                        <i class="fi-arrow-left show-for-large-up size-14"></i> 
                        <span>Back</span>
                      </a>
                    </div>
                  </div>
                </div>
                <!-- End of Help page -->

                <!-- Backup page -->
                <div id="backup" class="none">
                  <form name="backupForm">
                    <div class="input">
                      <input type="text" step="1" id="backupBackup" name="backupBackup" class="form-control" required="true" placeholder="Encrypted Backup">
                      <i class="icon-upload"></i>
                    </div>

                    <div class="input">
                      <input type="password" step="1" id="backupPassword" name="backupPassword" class="form-control" required="true" placeholder="Backup Password">
                      <i class="fi-lock"></i>
                    </div>

                    <div id="backup-wallet-password" class="input none">
                      <input type="password" step="1" id="backupWalletPassword" name="backupWalletPassword" class="form-control" required="true" placeholder="Wallet Password">
                      <i class="fi-lock"></i>
                    </div>

                    <button type="button" id="btnBackupDecrypt" class="button primary radius expand m0" disabled>Decrypt</button>
                  </form>

                  <div class="box-setup-footer">
                    <div class="left m10r">
                      <a id="btnBackupBack" class="button outline dark-gray tiny ng-click-active">
                        <i class="fi-arrow-left show-for-large-up size-14"></i> 
                        <span>Back</span>
                      </a>
                    </div>
                  </div>
                </div>
                <!-- End of Backup page -->

                <!-- Home (Phase 1) page -->
                <div id="phase1" class="">
                  <form name="phase1Form">
                    <div id="xprv-input" class="input">
                      <input type="text" class="form-control" id="xprv" name="xprv" placeholder="Master Private Key" required="true">
                      <i class="fi-key"></i>
                    </div>

                    <div id="address-input" class="input">
                      <input type="text" class="form-control" id="address" name="address" placeholder="Destination Address" required="true">
                      <i class="icon-paperplane"></i>
                    </div>
                    
                    <button id="btnRescue" type="button" class="button primary radius expand m0" disabled="disabled">
                        Rescue Coins
                      </button>
                  </form>

                  <div class="box-setup-footer">
                    <div class="right">
                      <a id="btnPhase1Settings" class="button outline dark-gray tiny">
                        <i class="icon-wrench show-for-large-up size-14"></i> 
                        <span>Settings</span>
                      </a>
                    </div>

                    <div class="left m10r">
                      <a id="btnPhase1Help" class="button outline dark-gray tiny ng-click-active">
                        <i class="icon-reference show-for-large-up size-14"></i> 
                        <span>Help</span>
                      </a>
                    </div>

                    <div class="left">
                      <a id="btnPhase1Backup" class="button outline dark-gray tiny">
                        <i class="icon-upload show-for-large-up size-14"></i> 
                        <span>Backup</span>
                      </a>
                    </div>
                  </div>
                </div>
                <!-- End of Home page -->

                <!-- Scanning (Phase 2) page -->
                <div id="phase2" class="settings none">
                  <form name="phase2Form">
                    <fieldset>
                      <legend>Scanning</legend>
                      <p class="text-gray">
                        Found <strong id="phase2-addresses">0</strong> addresses with a balance of <strong id="phase2-balance">0 START</strong>.
                      </p>

                      <div id="progressbar"></div>

                      <small class="text-gray">
                        Performing round <strong id="phase2-round">0</strong> with <strong id="phase2-naddresses">30</strong> addresses.
                      </small>
                    </fieldset>
                  </form>

                  <div class="box-setup-footer">
                    <div class="left m10r">
                      <a id="btnPhase2Cancel" class="button outline dark-gray tiny ng-click-active">
                        <i class="icon-close-circle show-for-large-up size-14" disabled></i> 
                        <span>Cancel</span>
                      </a>
                    </div>
                  </div>
                </div>
                <!-- End of Scanning (Phase 2) page -->

                <!-- Results (Phase 3) page -->
                <div id="phase3" class="settings none">
                  <form name="phase3Form">
                    <fieldset>
                      <legend>Results</legend>
                      <p class="text-gray">
                        Found <strong id="phase3-addresses">0</strong> addresses with a balance of <strong id="phase3-balance">0 START</strong>.
                      </p>

                      <p id="phase3-transaction" class="text-gray none">
                        This balance has been sent to <a href="" id="phase3-destination" target="_blank" title="Click here to view the address on the blockchain explorer">sKggkfUsaUFWeHsfoRD1cZcE4yydfp21yg</a>. You can track the transactions by clicking below.
                      </p>

                      <ul id="phase3-txid-list" class="none">
                        <!-- TXIDs are appended here -->
                      </ul>
                    </fieldset>

                    <div id="phase3-results-dialog" title="Results" class="none">
                      <table id="phase3-results">
                        <thead>
                          <tr>
                            <th>Address</th>
                            <th>Balance</th>
                          </tr>
                        </thead>
                        <tbody>
                          <!-- Addresses are appended here -->
                        </tbody>
                      </table>
                    </div>
                  </form>

                  <div class="box-setup-footer">
                    <div class="right">
                      <a id="btnPhase3Addresses" class="button outline dark-gray tiny">
                        <i class="icon-history show-for-large-up size-14"></i> 
                        <span>View Addresses</span>
                      </a>
                    </div>

                    <div class="left m10r">
                      <a id="btnPhase3StartAgain" class="button outline dark-gray tiny ng-click-active">
                        <i class="fi-arrow-left show-for-large-up size-14"></i> 
                        <span>Start Again</span>
                      </a>
                    </div>
                  </div>
                </div>
                <!-- End of Results (Phase 3) page -->

              </div>
              <div class="extra-margin-bottom"></div>
            </section>
          </div>
        </div>
      </div>
    </div>

  </body>
</html>